// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ hover –∑–≤–µ–∑–¥
function handleMouseMove(event) {
    const rect = canvas.getBoundingClientRect();
    const x = (event.clientX - rect.left) * (canvas.width / devicePixelRatio / rect.width);
    const y = (event.clientY - rect.top) * (canvas.height / devicePixelRatio / rect.height);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∑–≤–µ–∑–¥—ã
    if (hoveredStar) {
        hoveredStar.isHovered = false;
        hoveredStar.glow = getDefaultGlow(hoveredStar);
        hoveredStar = null;
    }
    
    tooltip.style.opacity = '0';
    tooltip.innerHTML = '';
    
    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∑–≤–µ–∑–¥—É
    let closestStar = null;
    let minDistance = Infinity;
    
    for (let star of stars) {
        const dx = x - star.x;
        const dy = y - star.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const hoverRadius = star.baseSize * 12; // –£–≤–µ–ª–∏—á–∏–ª–∏ —Ä–∞–¥–∏—É—Å —Ö–æ–≤–µ—Ä–∞
        
        if (distance < hoverRadius && distance < minDistance) {

            minDistance = distance;
            closestStar = star;
        }
    }
    
    if (closestStar) {
        closestStar.isHovered = true;
        closestStar.glow = getHoveredGlow(closestStar);
        hoveredStar = closestStar;
        showTooltip(closestStar, event.clientX, event.clientY);
    }
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è showTooltip
function showTooltip(star, clientX, clientY) {
    if (!star.name) {
        tooltip.innerHTML = `
            <div class="star-name">‚ú® –ó–≤–µ–∑–¥–∞ –≥–∞–ª–∞–∫—Ç–∏–∫–∏</div>
            <div class="star-info">–ù–∞–∂–º–∏ "–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é –∑–≤–µ–∑–¥—É"!</div>
        `;
    } else {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–≤–µ–∑–¥—ã
        let sourceBadge = '';
        let sourceColor = '#ffdd00';
        
        if (star.isGoogleStar) {
            sourceBadge = '<div style="color: #34a853; font-size: 11px; margin-bottom: 5px; font-weight: bold;">üåê Google –§–æ—Ä–º–∞</div>';

            sourceColor = '#34a853';
        } else if (star.isUserStar) {
            sourceBadge = '<div style="color: #ffdd00; font-size: 11px; margin-bottom: 5px; font-weight: bold;">‚≠ê –õ–∏—á–Ω–∞—è –∑–≤–µ–∑–¥–∞</div>';
            sourceColor = '#ffdd00';
        } else if (star.isMatvey) {
            sourceBadge = '<div style="color: #ff4444; font-size: 11px; margin-bottom: 5px; font-weight: bold;">üëë –°–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞</div>';
            sourceColor = '#ff4444';
        }
        
        // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        const maxReasonLength = 100;
        let reasonText = star.reason;
        if (reasonText.length > maxReasonLength) {
            reasonText = reasonText.substring(0, maxReasonLength) + '...';
        }
        
        tooltip.innerHTML = `
            ${sourceBadge}
            <div class="star-name" style="color: ${sourceColor}">‚≠ê ${star.name}</div>
            <div class="star-info"><strong>–ö–ª–∞—Å—Å:</strong> ${star.class}</div>
            <div class="star-info"><strong>–¶–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${star.value}</div>
            <div class="star-info"><strong>–ü–æ—á–µ–º—É:</strong> $

{reasonText}</div>
        `;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip
    tooltip.style.opacity = '1';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é tooltip
    const tooltipWidth = tooltip.offsetWidth || 300;
    const tooltipHeight = tooltip.offsetHeight || 150;
    
    let x = clientX + 20;
    let y = clientY + 20;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
    if (x + tooltipWidth > window.innerWidth) {
        x = clientX - tooltipWidth - 20;
    }
    
    if (y + tooltipHeight > window.innerHeight) {
        y = clientY - tooltipHeight - 20;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    x = Math.max(10, Math.min(x, window.innerWidth - tooltipWidth - 10));
    y = Math.max(10, Math.min(y, window.innerHeight - tooltipHeight - 10));
    
    tooltip.style.left = x + 'px';

    tooltip.style.top = y + 'px';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–≤–µ–∑–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ú–∞—Ç–≤–µ—è –∏ Google Forms)
    const userStarsFiltered = userStars.filter(star => 
        !star.isMatvey && !star.isGoogleStar
    );
    
    // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—á–Ω—ã—Ö –∑–≤–µ–∑–¥
    document.getElementById('totalStars').textContent = userStarsFiltered.length;
    
    if (userStarsFiltered.length > 0) {
        // –ú–æ–π –∫–ª–∞—Å—Å (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π –∑–≤–µ–∑–¥—ã)
        const lastStar = userStarsFiltered[userStarsFiltered.length - 1];
        document.getElementById('myClass').textContent = lastStar.class + ' –∫–ª–∞—Å—Å';
        
        // –ü–æ–¥—Å—á–µ—Ç —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
        const valueCount = {};
        userStarsFiltered.forEach(star => {
            const value = star.value || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            valueCount[value] = (valueCount[value] || 0) + 1;
        });
        
        // –ù–∞—Ö–æ–¥–∏–º –≥–ª–∞–≤–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å

        let mainValue = '-';
        let maxCount = 0;
        for (const [value, count] of Object.entries(valueCount)) {
            if (count > maxCount) {
                maxCount = count;
                mainValue = value;
            }
        }
        document.getElementById('myMainValue').textContent = mainValue;
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ø—É–ª—è—Ä–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å
        let popularValue = '-';
        let popularCount = 0;
        for (const [value, count] of Object.entries(valueCount)) {
            if (count > popularCount) {
                popularCount = count;
                popularValue = value;
            }
        }
        document.getElementById('popularValue').textContent = popularValue;
        
        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
        let distributionHTML = '';
        const sortedValues = Object.entries(valueCount)
            .sort((a, b) => b[1] - a[1]);
        
        sortedValues.forEach(([value, count]) => {
            const percentage = Math.round((count / 

userStarsFiltered.length) * 100);
            const color = CONFIG.VALUE_COLORS[value] || CONFIG.VALUE_COLORS['–î—Ä—É–≥–æ–π'];
            
            distributionHTML += `
                <div class="distribution-item">
                    <span style="min-width: 100px; color: ${color}; font-weight: bold;">${value}</span>
                    <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 0 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${Math.max(5, percentage)}%; background: ${color}; border-radius: 10px;"></div>
                    </div>
                    <span style="
